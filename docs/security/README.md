<p align="center"><img src="../img/lo.svg" width="260"></p>
<p align="center">

# Logging-operator && Security

---
## Contents
- **Using RBAC Authorization**
    - [Deploy with Kubernetes Manifests](#deploy-with-kubernetes-manifests)
    - [Deploy with Helm](#deploy-with-helm)
    - [Output](#example-manifest-generated-by-the-operator)
- **Service Account**  
    - [Deploy with Kubernetes Manifests](#deploy-with-kubernetes-manifests-1)
    - [Deploy with Helm](#deploy-with-helm-1)
- **Pod Security Policy**
    - [Deploy with Kubernetes Manifests](#create-logging-resource-with-psp)
    - [Deploy with Helm](#deploy-with-helm-2)
    - [Output](#example-manifest-generated-by-the-operator-1)
---


### Security Variables
| Variable Name | Type | Required | Default | Description |
|---|---|---|---|---|
| roleBasedAccessControlCreate | bool | No | True | create RBAC resources |
| podSecurityPolicyCreate | bool | No | False | create PSP resources |
| serviceAccount | string | No | - | Set ServiceAccount |

## Using [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/) Authorization
> By default the rbac is enabled.

### Deploy with Kubernetes Manifests
#### Create `logging` resource with RBAC
```bash
cat <<EOF | kubectl -n logging apply -f -
apiVersion: logging.banzaicloud.io/v1beta1
kind: Logging
metadata:
  name: default-logging-simple
spec:
  fluentd:
    security:
      roleBasedAccessControlCreate: true
  fluentbit:
    security:
      roleBasedAccessControlCreate: true
  controlNamespace: logging
EOF
```

### Deploy with Helm
```bash
helm install --namespace logging --name nginx-demo banzaicloud-stable/nginx-logging-demo \
    --set=loggingOperator.fluentd.security.roleBasedAccessControlCreate=True \
    --set=loggingOperator.fluentbit.security.roleBasedAccessControlCreate=True
```

### Example Manifest Generated by the operator

#### Fluentd Role & RoleBinding Output
``` 
- apiVersion: rbac.authorization.k8s.io/v1
  kind: Role
  metadata:
    name: nginx-demo-nginx-logging-demo-logging-fluentd
    namespace: logging
    ownerReferences:
    - apiVersion: logging.banzaicloud.io/v1beta1
      controller: true
      kind: Logging
  rules:
  - apiGroups:
    - ""
    resources:
    - configmaps
    - secrets
    verbs:
    - '*'

--
- apiVersion: rbac.authorization.k8s.io/v1
  kind: RoleBinding
  metadata:
    annotations:
    name: nginx-demo-nginx-logging-demo-logging-fluentd
    namespace: logging
    ownerReferences:
    - apiVersion: logging.banzaicloud.io/v1beta1
      controller: true
      kind: Logging
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: Role
    name: nginx-demo-nginx-logging-demo-logging-fluentd
  subjects:
  - kind: ServiceAccount
    name: nginx-demo-nginx-logging-demo-logging-fluentd
    namespace: logging


```

#### Fluentbit ClusterRole & ClusterRoleBinding Output
``` 
kind: ClusterRole
metadata:
  annotations:
  name: nginx-demo-nginx-logging-demo-logging-fluentbit
  ownerReferences:
  - apiVersion: logging.banzaicloud.io/v1beta1
    controller: true
    kind: Logging
rules:
- apiGroups:
  - ""
  resources:
  - pods
  - namespaces
  verbs:
  - get
  - list
  - watch

---
kind: ClusterRoleBinding
metadata:
  annotations:
  name: logging-nginx-demo-nginx-logging-demo-logging-fluentbit
  ownerReferences:
  - apiVersion: logging.banzaicloud.io/v1beta1
    controller: true
    kind: Logging
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: nginx-demo-nginx-logging-demo-logging-fluentbit
subjects:
- kind: ServiceAccount
  name: nginx-demo-nginx-logging-demo-logging-fluentbit
  namespace: logging

```
---

## Service Account ([SA](https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/))
### Deploy with Kubernetes Manifests
#### Create `logging` resource with Service Account
```bash
cat <<EOF | kubectl -n logging apply -f -
apiVersion: logging.banzaicloud.io/v1beta1
kind: Logging
metadata:
  name: default-logging-simple
spec:
  fluentd:
    security:
      serviceAccount: fluentdUser1
  fluentbit:
    security:
      serviceAccount: fluentbitUser1
  controlNamespace: logging
EOF
```
### Deploy with Helm
```bash
helm install --namespace logging --name nginx-demo banzaicloud-stable/nginx-logging-demo \
    --set=loggingOperator.fluentd.security.serviceAccount=fluentdUser1 \
    --set=loggingOperator.fluentbit.security.serviceAccount=fluentbitUser1
```

---
## Enabling Pod Security Policies ([PSP](https://kubernetes.io/docs/concepts/policy/pod-security-policy/))
> This option depends on the roleBasedAccessControlCreate enabled status because the psp require rbac roles also. 

### Deploy with Kubernetes Manifests
#### Create `logging` resource with PSP
```bash
cat <<EOF | kubectl -n logging apply -f -
apiVersion: logging.banzaicloud.io/v1beta1
kind: Logging
metadata:
  name: default-logging-simple
spec:
  fluentd:
    security:
      podSecurityPolicyCreate: true
      roleBasedAccessControlCreate: true
  fluentbit:
    security:
      podSecurityPolicyCreate: true
      roleBasedAccessControlCreate: true
  controlNamespace: logging
EOF
```
### Deploy with Helm
```bash
helm install --namespace logging --name nginx-demo banzaicloud-stable/nginx-logging-demo \
    --set=loggingOperator.fluentd.security.podSecurityPolicyCreate=True \
    --set=loggingOperator.fluentd.security.roleBasedAccessControlCreate=True \
    --set=loggingOperator.fluentbit.security.podSecurityPolicyCreate=True \
    --set=loggingOperator.fluentbit.security.roleBasedAccessControlCreate=True 
```

### Example Manifest Generated by the operator

#### Fluentd PSP+Role Output
``` 
kind: Role
metadata:
  name: nginx-demo-nginx-logging-demo-logging-fluentd-psp
  namespace: logging
rules:
- apiGroups:
  - policy
  resources:
  - nginx-demo-nginx-logging-demo-logging-fluentd
  verbs:
  - use

---
kind: PodSecurityPolicy
metadata:
  name: nginx-demo-nginx-logging-demo-logging-fluentd
spec:
  allowPrivilegeEscalation: false
  fsGroup:
    ranges:
    - max: 65535
      min: 1
    rule: MustRunAs
  runAsUser:
    ranges:
    - max: 65535
      min: 1
    rule: MustRunAs
  seLinux:
    rule: RunAsAny
  supplementalGroups:
    ranges:
    - max: 65535
      min: 1
    rule: MustRunAs
  volumes:
  - configMap
  - emptyDir
  - secret
  - persistentVolumeClaim


```
#### Fluentbit PSP+ClusterRole Output
```
kind: ClusterRole
metadata:
  name: nginx-demo-nginx-logging-demo-logging-fluentbit-psp
rules:
- apiGroups:
  - policy
  resources:
  - nginx-demo-nginx-logging-demo-logging-fluentbit
  verbs:
  - use
---
kind: PodSecurityPolicy
metadata:
  name: nginx-demo-nginx-logging-demo-logging-fluentbit
spec:
  allowPrivilegeEscalation: false
  allowedHostPaths:
  - pathPrefix: /var/lib/docker/containers
    readOnly: true
  - pathPrefix: /var/log
    readOnly: true
  fsGroup:
    ranges:
    - max: 65535
      min: 1
    rule: MustRunAs
  readOnlyRootFilesystem: true
  runAsUser:
    ranges:
    - max: 65535
      min: 1
    rule: MustRunAs
  seLinux:
    rule: RunAsAny
  supplementalGroups:
    ranges:
    - max: 65535
      min: 1
    rule: MustRunAs
  volumes:
  - configMap
  - emptyDir
  - secret
  - hostPath
```
